/*!
 * @websanova/vue-auth v3.2.1-beta
 * https://websanova.com/docs/vue-auth
 * Released under the MIT License.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.VueAuth=e()}(this,function(){"use strict";function s(t){return null!==t&&"object"==typeof t&&t.constructor!==Array}function c(t){return"string"==typeof t||"number"==typeof t?[t]:t}function u(t,e){var n,o,r,i={};for(r in e=e||{},t)s(t[r])&&"FormData"!==t[r].constructor.name?i[r]=u(t[r],{}):i[r]=t[r];for(n=0,o=(e=e.constructor!==Array?[e]:e).length;n<o;n++)for(r in e[n])s(e[n][r])&&"FormData"!==e[n][r].constructor.name?i[r]=u(t[r]||{},[e[n][r]]):i[r]=e[n][r];return i}function l(t,e){var n,o,r;if("[object Object]"===Object.prototype.toString.call(t)&&"[object Object]"===Object.prototype.toString.call(e)){for(r in t)if(l(t[r],e[r]))return!0}else if(t=c(t),e=c(e),t&&e&&t.constructor===Array&&e.constructor===Array)for(n=0,o=t.length;n<o;n++)if(0<=e.indexOf(t[n]))return!0;return!1}function r(t,e,n){var o,r=t+"="+e+";";for(o in n)!1!==n[o]&&void 0!==n[o]&&(null===n[o]?this.options["getCookie"+o]&&(r+=" "+o+"="+this.options["getCookie"+o]()+";"):!0===n[o]?r+=" "+o+";":r+=" "+o+"="+n[o]+";");document.cookie=r}function i(t){return"string"!=typeof t&&null!=t?new Date((new Date).getTime()+t).toUTCString():t}function e(t){var e=Object.assign({},this.options.cookie);e.Expires=i(-12096e5),r.call(this,t,"",e)}var p=Object.freeze({get:function(t){for(var e=document.cookie,n=0,o=(e=e.replace(/;\s+/g,";").split(";").map(function(t){return t.replace(/\s+=\s+/g,"=").split("=")})).length;n<o;n++)if(e[n][0]&&e[n][0]===t)return e[n][1];return null},set:function(t,e,n){var o=this.options.cookie;o.Expires=!0===n?"":i(o.Expires),r.call(this,t,e,o)},remove:e});var f=Object.freeze({get:function(t){return sessionStorage.getItem(t)||localStorage.getItem(t)},set:function(t,e,n){(n?sessionStorage:localStorage).setItem(t,e)},remove:function(t){localStorage.removeItem(t),sessionStorage.removeItem(t)}});function o(t,e,n,o){var r=0,i=this.options.stores,a=i.length,s=[function(t){return(t=t||this.currentToken)||(this.impersonating()?this.options.tokenImpersonateKey:this.options.tokenDefaultKey)}.call(this,e)];for("set"===t&&(s.push(n),s.push(!0===o));r<a;r++){if("storage"===i[r]&&function(){try{if(window.localStorage)return localStorage.setItem("storage_test",1),localStorage.removeItem("storage_test"),1;throw"exception"}catch(t){}}()&&function(){try{if(window.sessionStorage)return sessionStorage.setItem("storage_test",1),sessionStorage.removeItem("storage_test"),1;throw"exception"}catch(t){}}())return f[t].apply(this,s);if("cookie"===i[r])return p[t].apply(this,s)}}function h(t){return o.call(this,"get",t)}function d(t,e,n){return o.call(this,"set",t,e,n)}function a(t){return o.call(this,"remove",t)}var m=null,n={rolesKey:"roles",rememberKey:"auth_remember",staySignedInKey:"auth_stay_signed_in",tokenDefaultKey:"auth_token_default",tokenImpersonateKey:"auth_token_impersonate",stores:["storage","cookie"],cookie:{Path:"/",Domain:null,Secure:!0,Expires:12096e5,SameSite:"None"},authRedirect:{path:"/login"},forbiddenRedirect:{path:"/403"},notFoundRedirect:{path:"/404"},registerData:{url:"auth/register",method:"POST",redirect:"/login",autoLogin:!1},loginData:{url:"auth/login",method:"POST",redirect:"/",fetchUser:!0,staySignedIn:!0},logoutData:{url:"auth/logout",method:"POST",redirect:"/",makeRequest:!1},fetchData:{url:"auth/user",method:"GET",enabled:!0},refreshData:{url:"auth/refresh",method:"GET",enabled:!0,interval:30},impersonateData:{url:"auth/impersonate",method:"POST",redirect:"/",fetchUser:!0},unimpersonateData:{url:"auth/unimpersonate",method:"POST",redirect:"/admin",fetchUser:!0,makeRequest:!1},oauth2Data:{url:"auth/social",method:"POST",redirect:"/",fetchUser:!0},getUrl:v,getCookieDomain:function(){return window.location.hostname},parseUserData:function(t){return t.data||{}},parseRefreshData:function(t){return t.data||{}}};function y(){return!h.call(m)}function g(t){var e;return t.to?e=t.to.auth:(t=t.matched.filter(function(t){return Object.prototype.hasOwnProperty.call(t.meta,"auth")})).length&&(e=t[t.length-1].meta.auth),e}function v(){var t=window.location.port;return window.location.protocol+"//"+window.location.hostname+(t?":"+t:"")}function b(t){m.$vm.loaded=!0,m.$vm.authenticated=t}function D(t){!0===t?d.call(m,m.options.staySignedInKey,"true",!1):a.call(m,m.options.staySignedInKey)}function k(t){t?(d.call(m,m.options.rememberKey,t,!1),m.$vm.remember=t):(a.call(m,m.options.rememberKey),m.$vm.remember=null)}function w(t){m.transitionPrev=m.transitionThis,m.transitionThis=t}function S(t){return m.options.parseUserData(m.http.httpData(t))}function I(t){var e;return t&&t.ignoreVueAuth||(!1===t.impersonating&&m.impersonating()&&(e=m.options.tokenDefaultKey),(e=h.call(m,e))&&m.auth.request.call(m,t,e)),t}function $(t,e){if(!e||!e.ignoreVueAuth){var n,o,e=t,r=m.transitionThis,i="",a=r&&r.path;if(a&&r.query){for(n in r.query)r.query[n]&&(i+="&"+n+"="+r.query[n]);a+="?"+i.substring(1)}m.http.invalidToken&&m.http.invalidToken.call(m,e)&&(r&&(o=g(r)),O({redirect:a=o?o.redirect||m.authRedirect:a})),(e=this.auth.response.call(this,t))&&d.call(this,null,e,!h.call(m,m.options.staySignedInKey))}}function T(t){var e=y();e&&m.$vm.authenticated&&O(),e||m.$vm.loaded||!m.options.refreshData.enabled?K(t):m.refresh().then(function(){K(t)})}function K(t){null===m.$vm.authenticated&&h.call(m)?m.options.fetchData.enabled?m.fetch().then(t,t):(P({}),t.call(m)):(m.$vm.loaded=!0,t.call(m))}function R(t,e,n){var o=(e||"").redirect||m.options.authRedirect,r=(e||"").forbiddenRedirect||(e||"").redirect||m.options.forbiddenRedirect,i=(e||"").notFoundRedirect||(e||"").redirect||m.options.notFoundRedirect,a=c(void 0!==(e||"").excludes?e.excludes:void 0);if((e=c(void 0!==(e||"").roles?e.roles:e))&&(!0===e||e.constructor===Array||s(e)))if(m.check()){if(e.constructor!==Array&&!s(e)||l(e,m.$vm.data[m.options.rolesKey])&&!l(a,m.$vm.data[m.options.rolesKey]))return m.$vm.redirect=m.transitionRedirectType?{type:m.transitionRedirectType,from:m.transitionPrev,to:m.transitionThis}:null,m.transitionRedirectType=null,n();m.transitionRedirectType=403,"function"==typeof r&&(r=r(t)),n.call(m,r)}else m.transitionRedirectType=401,"function"==typeof o&&(o=o(t)),n.call(m,o);else{if(!1!==e||!m.check())return m.$vm.redirect=m.transitionRedirectType?{type:m.transitionRedirectType,from:m.transitionPrev,to:m.transitionThis}:null,m.transitionRedirectType=null,n();m.transitionRedirectType=404,"function"==typeof i&&(i=i(t)),n.call(m,i)}}function P(t,e){m.$vm.data=t,b(!0),U(e)}function O(t){e.call(m,m.options.tokenImpersonateKey),e.call(m,m.options.tokenDefaultKey),a.call(m,m.options.tokenImpersonateKey),a.call(m,m.options.tokenDefaultKey),a.call(m,m.options.staySignedInKey),m.$vm.loaded=!0,m.$vm.authenticated=!1,m.$vm.data=null,U(t)}function U(t){t&&m.router.routerGo.call(m,t)}function _(t,e){e=e||{},(m=this).Vue=t,this.auth=e.auth,this.http=e.http,this.router=e.router,this.options=u(n,e),this.currentToken=null,this.transitionPrev=null,this.transitionThis=null,this.transitionRedirectType=null,function(){for(var t=["auth","http","router"],e=0,n=t.length;e<n;e++){if(!m.options[t[e]])return console.error('Error (@websanova/vue-auth): "'+t[e]+'" driver must be set.');if(m.options[t[e]]._init&&(msg=m.options[t[e]]._init.call(m)))return console.error("Error (@websanova/vue-auth): "+msg)}}(),m.$vm=new m.Vue({data:function(){return{data:null,loaded:!1,redirect:null,authenticated:null,impersonating:void 0,remember:void 0}}}),m.options.refreshData.enabled&&0<m.options.refreshData.interval&&setInterval(function(){m.options.refreshData.enabled&&m.$vm.authenticated&&!y()&&m.refresh()},1e3*m.options.refreshData.interval*60),m.http.interceptor.call(m,I,$),m.router.beforeEach.call(m,T,R,w,g)}function t(t,e){t.auth=new _(t,e),Object.defineProperties(t.prototype,{$auth:{get:function(){return t.auth}}})}return _.prototype.ready=function(){return m.$vm.loaded},_.prototype.load=function(){return new Promise(function(t){var e=null,e=setInterval(function(){m.$vm.loaded&&(clearInterval(e),t())},50)})},_.prototype.redirect=function(){return m.$vm.redirect},_.prototype.user=function(t){return void 0!==t&&P(t),m.$vm.data},_.prototype.check=function(t,e){return t=t,e=e,!0===m.$vm.authenticated&&(!t||l(t,(m.$vm.data||{})[e||m.options.rolesKey]))},_.prototype.impersonating=function(){var t=!!h.call(m,m.options.tokenImpersonateKey);return void 0===m.$vm.impersonating&&(m.$vm.impersonating=t),m.$vm.impersonating},_.prototype.token=function(t,e,n){return void 0!==e&&(null===e?a.call(m,t):(n=!0===n||!1===n?n:!h.call(m,m.options.staySignedInKey),d.call(m,t,e,n))),h.call(m,t)},_.prototype.fetch=function(n){return n=u(m.options.fetchData,n),new Promise(function(e,t){m.http.http.call(m,n).then(function(t){P(S(t),n.redirect),e(t)},t)})},_.prototype.refresh=function(n){return n=u(m.options.refreshData,n),new Promise(function(e,t){m.http.http.call(m,n).then(function(t){m.options.parseRefreshData(m.http.httpData(t)),e(t)},t)})},_.prototype.register=function(r){var i=u(m.options.registerData,r);return new Promise(function(n,o){m.http.http.call(m,i).then(function(t){var e;i.autoLogin?(e=u(m.options.loginData,r),m.login(e).then(n,o)):(n(t),U(i.redirect))},o)})},_.prototype.setStaySignedIn=function(t){D(t)},_.prototype.login=function(o){return k((o=u(m.options.loginData,o)).remember),D(o.staySignedIn),new Promise(function(e,n){m.http.http.call(m,o).then(function(t){o.fetchUser||void 0===o.fetchUser&&m.options.fetchData.enabled?m.fetch({redirect:o.redirect}).then(e,n):(P(S(t),o.redirect),e(t))},function(t){b(!1),n(t)})})},_.prototype.remember=function(t){t&&k(t);t=h.call(m,m.options.rememberKey);return void 0===m.$vm.remember&&(m.$vm.remember=t),m.$vm.remember},_.prototype.unremember=function(){k(null)},_.prototype.logout=function(n){return n=u(m.options.logoutData,n),new Promise(function(e,t){n.makeRequest?m.http.http.call(m,n).then(function(t){O(n.redirect),e(t)},t):(O(n.redirect),e())})},_.prototype.impersonate=function(a){return a=u(m.options.impersonateData,a),new Promise(function(o,r){var i=m.token();m.http.http.call(m,a).then(function(t){var e,n;e=i,d.call(m,m.options.tokenImpersonateKey,m.token(),!h.call(m,m.options.staySignedInKey)),d.call(m,m.options.tokenDefaultKey,e,!h.call(m,m.options.staySignedInKey)),m.$vm.impersonating=!0,U(n),a.fetchUser||void 0===a.fetchUser&&m.options.fetchData.enabled?m.fetch({redirect:a.redirect}).then(o,r):(U(a.redirect),o(t))},r)})},_.prototype.unimpersonate=function(n){return n=u(m.options.unimpersonateData,n),new Promise(function(t,e){n.makeRequest?m.http.http.call(m,n).then(t,e):t()}).then(function(){return new Promise(function(t,e){a.call(m,m.options.tokenImpersonateKey),m.$vm.impersonating=!1,U(void 0),n.fetchUser||void 0===n.fetchUser&&m.options.fetchData.enabled?m.fetch({redirect:n.redirect}).then(t,e):(U(n.redirect),t())})})},_.prototype.oauth2=function(t,e){var n,o="";if(e.code){try{e.state&&(e.state=JSON.parse(decodeURIComponent(e.state)))}catch(t){console.error("vue-auth:error There was an issue retrieving the state data."),e.state=e.state||{}}return delete(e=u(m.options.oauth2Data,[e.state,e])).code,delete e.state,delete e.params,m.login(e)}for(n in(e=u(m.options.oauth2[t],e)).params.state=JSON.stringify(e.params.state||{}),e.params.redirect_uri=(t=e.params.redirect_uri,/^https?:\/\//.test(t=t||"")?t:v()+"/"+t.replace(/^\/|\/$/g,"")),e.params)o+="&"+n+"="+encodeURIComponent(e.params[n]);window.location=e.url+"?"+o.substring()},_.prototype.enableImpersonate=function(){m.impersonating()&&(m.currentToken=null)},_.prototype.disableImpersonate=function(){m.impersonating()&&(m.currentToken=m.options.tokenDefaultKey)},"undefined"!=typeof window&&window.Vue&&window.Vue.use(t),t});